{% if site.google_analytics and site.google_analytics != "G-XXXXXXXXXX" %}
<!-- Google Analytics (GA4) -->
<script async src="https://www.googletagmanager.com/gtag/js?id={{ site.google_analytics }}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', '{{ site.google_analytics }}');
</script>
{% endif %}

<!-- Theme Toggle -->
<script>
  (() => {
    // Theme toggle
    document.querySelectorAll('.theme-toggle').forEach(toggle => {
      toggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
      });
    });

    // System theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', ({ matches }) => {
      if (!localStorage.getItem('theme')) {
        document.documentElement.setAttribute('data-theme', matches ? 'dark' : 'light');
      }
    });

    // Mobile nav toggle
    const navToggle = document.querySelector('.nav-toggle');
    const nav = document.querySelector('.nav');
    navToggle?.addEventListener('click', () => {
      const isOpen = nav.classList.toggle('is-open');
      navToggle.setAttribute('aria-expanded', isOpen);
    });
  })();
</script>

<!-- Bandcamp Lazy Load -->
<script>
  (() => {
    document.querySelectorAll('.bandcamp-player').forEach(player => {
      player.addEventListener('click', () => {
        if (player.classList.contains('loading') || player.querySelector('iframe')) return;

        const albumId = player.dataset.album;
        if (!albumId) return;

        player.classList.add('loading');

        const iframe = document.createElement('iframe');
        iframe.src = `https://bandcamp.com/EmbeddedPlayer/album=${albumId}/size=large/bgcol=ffffff/linkcol=333333/minimal=true/transparent=true/`;
        iframe.setAttribute('seamless', '');
        iframe.setAttribute('loading', 'lazy');

        iframe.onload = () => {
          player.querySelector('img').style.display = 'none';
          player.querySelector('.play-button').style.display = 'none';
          player.classList.remove('loading');
        };

        player.appendChild(iframe);
      });
    });
  })();
</script>

<!-- Accordion -->
<script>
  (() => {
    const accordions = document.querySelectorAll('.accordion-section');
    if (!accordions.length) return;

    accordions.forEach((section, index) => {
      const trigger = section.querySelector('.accordion-trigger');
      const content = section.querySelector('.accordion-content');
      if (!trigger || !content) return;

      // First section open by default
      const isOpen = index === 0;
      trigger.setAttribute('aria-expanded', isOpen);
      content.setAttribute('aria-hidden', !isOpen);

      trigger.addEventListener('click', () => {
        const wasOpen = trigger.getAttribute('aria-expanded') === 'true';

        // Close all other sections (one at a time behavior)
        accordions.forEach(other => {
          const otherTrigger = other.querySelector('.accordion-trigger');
          const otherContent = other.querySelector('.accordion-content');
          if (otherTrigger && otherContent && other !== section) {
            otherTrigger.setAttribute('aria-expanded', 'false');
            otherContent.setAttribute('aria-hidden', 'true');
          }
        });

        // Toggle current section
        trigger.setAttribute('aria-expanded', !wasOpen);
        content.setAttribute('aria-hidden', wasOpen);
      });
    });
  })();
</script>
