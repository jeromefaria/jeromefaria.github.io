{% if site.google_analytics and site.google_analytics != "G-XXXXXXXXXX" %}
<!-- Google Analytics (GA4) -->
<script async src="https://www.googletagmanager.com/gtag/js?id={{ site.google_analytics }}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', '{{ site.google_analytics }}');
</script>
{% endif %}

<!-- Page Transitions -->
<script>
  (() => {
    const main = document.querySelector('main');
    if (!main) return;

    document.addEventListener('click', e => {
      const link = e.target.closest('a');
      if (!link) return;

      const href = link.getAttribute('href');
      // Only intercept internal links (same origin, not anchors, not new tabs)
      if (!href ||
          href.startsWith('#') ||
          href.startsWith('mailto:') ||
          href.startsWith('http') ||
          link.target === '_blank' ||
          e.ctrlKey || e.metaKey || e.shiftKey) return;

      e.preventDefault();
      main.classList.add('is-leaving');

      setTimeout(() => {
        window.location.href = href;
      }, 300);
    });
  })();
</script>

<!-- Mobile Nav Toggle -->
<script>
  (() => {
    // Mobile nav toggle
    const navToggle = document.querySelector('.nav-toggle');
    const nav = document.querySelector('.nav');
    navToggle?.addEventListener('click', () => {
      const isOpen = nav.classList.contains('is-open');
      if (isOpen) {
        nav.classList.add('is-closing');
        nav.classList.remove('is-open');
        navToggle.setAttribute('aria-expanded', 'false');
        setTimeout(() => nav.classList.remove('is-closing'), 300);
      } else {
        nav.classList.add('is-open');
        navToggle.setAttribute('aria-expanded', 'true');
      }
    });
  })();
</script>

<!-- Bandcamp Lazy Load -->
<script>
  (() => {
    document.querySelectorAll('.bandcamp-player').forEach(player => {
      player.addEventListener('click', () => {
        if (player.classList.contains('loading') || player.querySelector('iframe')) return;

        const albumId = player.dataset.album;
        if (!albumId) return;

        player.classList.add('loading');

        const iframe = document.createElement('iframe');
        iframe.src = `https://bandcamp.com/EmbeddedPlayer/album=${albumId}/size=large/bgcol=000000/linkcol=ffffff/minimal=true/transparent=true/`;
        iframe.setAttribute('seamless', '');
        iframe.setAttribute('loading', 'lazy');

        iframe.onload = () => {
          player.querySelector('img').style.display = 'none';
          player.querySelector('.play-button').style.display = 'none';
          player.classList.remove('loading');
        };

        player.appendChild(iframe);
      });
    });
  })();
</script>

<!-- Accordion -->
<script>
  (() => {
    const accordions = document.querySelectorAll('.accordion-section');
    if (!accordions.length) return;

    accordions.forEach(section => {
      const trigger = section.querySelector('.accordion-trigger');
      const content = section.querySelector('.accordion-content');
      if (!trigger || !content) return;

      trigger.addEventListener('click', () => {
        const wasOpen = trigger.getAttribute('aria-expanded') === 'true';

        // Close all other sections (one at a time behavior)
        accordions.forEach(other => {
          const otherTrigger = other.querySelector('.accordion-trigger');
          const otherContent = other.querySelector('.accordion-content');
          if (otherTrigger && otherContent && other !== section) {
            otherTrigger.setAttribute('aria-expanded', 'false');
            otherContent.setAttribute('aria-hidden', 'true');
          }
        });

        // Toggle current section
        trigger.setAttribute('aria-expanded', !wasOpen);
        content.setAttribute('aria-hidden', wasOpen);

        // Scroll to top of section when opening
        // Delay scroll to wait for other sections to collapse (300ms transition)
        if (!wasOpen) {
          setTimeout(() => {
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 320);
        }
      });
    });
  })();
</script>
